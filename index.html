<!DOCTYPE html>
<html lang="es">

<head>
<meta charset="UTF-8">
<title>Malla Curricular Arquitectura</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase SDK (compat â€” mÃ¡s simple) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDGFEsBWnEHP3luKaeaFzUe_Nguqz3j_pA",
  authDomain: "malla-curricular-arquitectura.firebaseapp.com",
  projectId: "malla-curricular-arquitectura",
  storageBucket: "malla-curricular-arquitectura.appspot.com",
  messagingSenderId: "613677284410",
  appId: "1:613677284410:web:3c0d68721e74f054378903"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
</script>

<style>
/* ---- TU CSS IGUAL ---- */
</style>
</head>

<body>

<div id="auth">
  <button onclick="loginGoogle()">Iniciar sesiÃ³n con Google</button>
  <button onclick="logout()">Cerrar sesiÃ³n</button>
</div>

<h1>MALLA CURRICULAR ARQUITECTURA</h1>

<div class="progreso-box">
  <p id="porcentaje">Progreso: 0%</p>
  <div class="progreso-barra"><div id="barra"></div></div>
  <p id="mensaje"></p>
  <button onclick="reiniciar()">Reiniciar progreso</button>
</div>

<div class="malla" id="malla"></div>

<script>
let usuario = null;

auth.onAuthStateChanged(u => {
  usuario = u;
  render();
});

function loginGoogle(){
  const provider=new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider);
}

function logout(){
  auth.signOut();
}

const mensajes = [
 {p:0,m:"Todo gran proyecto empieza con una idea ğŸŒ±"},
 {p:10,m:"Vas tomando forma, sigue asÃ­ âœï¸"},
 {p:25,m:"Ya estÃ¡s construyendo bases sÃ³lidas ğŸ§±"},
 {p:50,m:"Mitad del camino, tu esfuerzo se nota ğŸ’š"},
 {p:75,m:"Casi arquitecta, no te detengas ğŸ—ï¸"},
 {p:90,m:"EstÃ¡s muy cerca del sueÃ±o âœ¨"},
 {p:100,m:"Â¡LO LOGRASTE! Arquitecta en proceso ğŸ“"}
];

/* ---- TU DATA IGUAL ---- */
</script>

<script>
async function render(){

const m=document.getElementById("malla");
m.innerHTML="";
let total=0,ok=0;

let materiasAprobadas={};

if(usuario){
 const snap = await db.collection("usuarios")
   .doc(usuario.uid)
   .collection("materias")
   .get();

 snap.forEach(d=>materiasAprobadas[d.id]=true);
}

data.forEach(a=>{
 const d=document.createElement("div");
 d.className="ano";
 d.innerHTML=`<h2>${a.aÃ±o}</h2>`;

 a.semestres.forEach(s=>{
  const sd=document.createElement("div");
  sd.className="semestre";
  sd.innerHTML=`<h3>${s.nombre}</h3>`;

  s.materias.forEach(x=>{
   total++;

   let nombre=typeof x==="string"?x:x.n;
   let p=typeof x==="string"?[]:x.p;

   const div=document.createElement("div");
   div.className="materia";
   div.textContent=nombre;

   const aprobado = materiasAprobadas[nombre];
   if(aprobado){div.classList.add("aprobada");ok++;}

   const faltan = p.filter(r=>!materiasAprobadas[r]);
   if(faltan.length){
     div.classList.add("bloqueada");
     div.dataset.tooltip="Falta: "+faltan.join(", ");
   }

   div.onclick=async ()=>{
     if(!usuario) return alert("Inicia sesiÃ³n ğŸ’š");
     if(faltan.length) return;

     if(aprobado){
       await db.collection("usuarios").doc(usuario.uid)
        .collection("materias").doc(nombre).delete();
     } else {
       await db.collection("usuarios").doc(usuario.uid)
        .collection("materias").doc(nombre).set({ok:true});
     }

     render();
   };

   sd.appendChild(div);
  });

  d.appendChild(sd);
 });

 m.appendChild(d);
});

const pct=Math.round(ok/total*100);
document.getElementById("barra").style.width=pct+"%";
document.getElementById("porcentaje").textContent="Progreso: "+pct+"%";

let msg=mensajes[0].m;
mensajes.forEach(x=>{if(pct>=x.p)msg=x.m});
document.getElementById("mensaje").textContent=msg;

}

function reiniciar(){
 if(!usuario)return alert("Inicia sesiÃ³n");
 if(confirm("Â¿Borrar progreso?")){
  db.collection("usuarios").doc(usuario.uid).collection("materias")
  .get().then(snap=>{
    snap.forEach(d=>d.ref.delete());
    render();
  });
 }
}

render();
</script>

</body>
</html>
